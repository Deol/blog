title: "基于「Webank 宣传游戏」总结的 CDC 实习总结"
date: 2015-9-30 16:00:00
categories: Thought
---

终于也到了要离开 CDC 的时候。
从第一天实习到现在 72 天，这两个多月给了我太多复杂的体验。

从负向的方面来讲，对自己技术的不自信导致的沉默寡言、缺乏沟通，思维陷入泥沼，以前所有自以为清晰的逻辑思维能力和创造力好像统统不见。
但从积极的方向来说，这两个月也学到了太多不靠实践不能体会的东西。
<!-- more -->

果然还是才疏学浅，不过现在知道差距在哪就好，也只能一步一个脚印踏踏实实地走，慢慢磨砺了。

接下来关于「Webank 宣传游戏」的总结有五部分，如下所示，最后是实习感言。

 1. 开发流程
 2. CSS3 动画实践
 3. 音频处理
 4. 细节优化
 5. 体验提升

---
**第一部分，开发流程。**

在公司跟在学校开发最大的不同，在于时间的把握和规划。
似乎很简单并不需要拿出来讲的东西，真正实践时才知道并不如此。
在公司里项目和需求需要排期，因此如何在大期限中划分小任务去逐步完成其实也是学问。

职场新人一开始参加工作很可能会「苛求完美」，导致进度缓慢不能如期交付。
如果再加上不善沟通，那么可能从一开始动手就会走偏做错，到后期改错成本巨大。

从前端体验开发的角度来说，一个合理的开发流程类似于：

![UI 开发流程][1]

如果流程不合理，自己很可能因为拘于细节而浪费大量时间，拖慢进度。

而如若流程合理和给的项目总开发时间确定，根据流程去切分任务，就能知道每个任务可分配的时间是多少，然后将它们添加到 Todo List 当中，抓紧完成。
而每完成一个大目标，自己都应该主动跟导师汇报进度，定期跟产品或设计师沟通，确保任务不出偏差。

---

**第二部分，CSS3 动画实践**

先记录一下巨好用的利用 Chrome 进行动画调试的方法：

>  1. 先在 chrome://flags 中开启开发者工具实验 #enable-devtools-experiments；
>  2. 开启 Settings 里面 Experiments 下的 Animation Inspection；
>  3. 在 Elements 标签下，点击右上角的双矩形图标启用 Animation Control，刷新即可。

受益于动画专家桑尼桑的指导，这两个月自己对 CSS3 动画尝试不少，在最近做的「Webank宣传游戏」中也运动了桑尼「动画十四原则」的其中一些，感悟良多。
（好吧实话说吧，正常的动画制作流程是拿给桑尼看，等他笑完之后再说说哪里不合理再改改改...T T）

① Loading 部分：
![loading][2]

loading 改了两版，第一版是右手是举起来不停挥手，但是这样左边的小金币看起来就显得略微鸡肋，而且不够自然，于是就改成了现在的小企鹅玩金币。

简单来说，主要的运动成分有企鹅和金币。

企鹅部分，最主要的是手部一开始一个向上的「预备动作」，以及接住金币时需要跟随金币做小幅度的「惯性」运动。
而由于惯性，身体也需要有小幅度的摇摆。
具体怎么摇摆？手举起来大家一起晃两晃就知道啦。
关键词：rotate

金币部分，当企鹅的手接触金币的瞬间，根据动量守恒定律（毛线...应用条件都不成立），发生碰撞时金币发生了一瞬间的「挤压」，然后滚到另一只手，被另一只手 hold 住的时候稍稍往回转了一点点，这是「跟随和重叠动作」。
关键词：scale\rotate\translate

②洒钱部分：
![洒钱][3]

这部分也是三部分内容，钞票、企鹅和旋转背景。

钞票是关键，小企鹅看到漫天的钞票哗啦啦的掉下来才能出现丧心病狂的喜悦感。
既然是漫天，就说明钞票巨多，在我们看起来它们是有「深度」的，远远近近。
因此其实钞票分前景和后景，怎么区分？其实它们只有透明度 (opacity) 的区别。
而所有的钞票用的其实都是同一个类似树叶飘落的轨迹，落到下方后渐隐消失，这种快慢和交错的层次感，都是靠 duration 和 delay 实现的。
关键词：translate\rotate\opacity

小企鹅，还是手部和身体两部分。
手部先是一个向下的「预备动作」，然后巨开心的挥手，挥手的幅度逐渐变小直到静止。
身体跟随手部运动，产生「挤压与伸展」和重心的升降，说人话就是先设定 transform-origin 在肚子那里，然后根据手部运动产生身体的位移和挤压拉伸。
关键词：translate\scale

旋转背景，设计师给的图当然不会是整张可旋转的大图，所以自己可以用 PS 把原图翻转拼接然后处理一下，让它变成可旋转的大图，高光也可以直接加到背景里面。
什么？直接旋转会有白色底漏出来？直接把图放大一下就好啦。
关键词：scale\rotate

③蓄力部分：
![蓄力][4]

蓄力的流程是，当点击「 We 帮你蓄力」按钮之后，小企鹅 chua 一下子从左右两边随机划出来，企鹅君口中振振有词手中挥舞魔术棒，略施魔法撒点星芒，钞票君就醒来啦。

效果如图，划分动画，主要是小企鹅和星星、钞票三部分。

小企鹅部分，先是一个整体划出的效果，然后挥棒。
这里如果魔法棒跟手挥动幅度一样的话会显得生硬，所以将魔法棒单独取出来，挥动时使魔法棒的幅度稍大于手臂的幅度。
这里的细节处理是，小企鹅从左右哪边先出来和从上面哪个地方出来都是随机的，若先出来的企鹅在上面，则做缩小处理，以营造远近不同的「深度」感。
关键词：translate\rotate

星星部分，简单来说，一开始全部星星集中于魔术棒最大挥棒角度时点下的那点，分两次从原点被挥洒到钞票上，然后再自由下落渐隐消失。
再说人话也就是设定每个星星的位移变化，为了生动加上些旋转角度，然后将透明度从 0 → 1 → 0 变化。
关键词：translate\rotate\opacity

钞票部分，这是一个唤醒钞票的动画。
在一张蓝色钞票变成红色钞票的变化单元中，红色钞票叠在蓝色钞票之上，并且默认不显示，而且背景位置默认显示为中心以产生固定效果。
当钞票需要被唤醒时，红色钞票宽高逐渐变大，随之增大圆角直到全部显示。

这里有两个小细节：
第一、由于 Android 对 CSS 遮罩 (-webkit-mask) 的支持情况不足，所以只在 iOS 端做了 CSS 图片遮罩，也就是上图看到的一开始变幻时的边界模糊效果。关于 CSS 遮罩，简单来说，图像 rgba 上的第四个通道 alpha 通道，定义每个像素上的透明度。白色意味着不透明，黑色意味着透明，介于黑白之间的灰色表示半透明。所以这里加的是椭圆的黑色模糊遮罩，形成半透明效果；
第二、圆角 (border-radius) 的设定值可以是 a px / b px，同时设定水平半径和垂直半径就可以实现椭圆效果。（特别拿出来说是因为我以为就只能有圆形效果...之前死活搞不出椭圆被桑尼轻笑一声虐了...）
关键词：-webkit-mask/border-radius

时间有限，动画就分析这三个啦。
换言之，做动画也需要遵循物理规律，但是可以灵活变动加些夸张手法。
再者就是，用自己的身体去感受去体会，就像动画片说的一样，你带着什么样的情绪去做饭，吃饭的人会感受得到的哇哈哈哈哈听起来好中二。

---

**第三部分，音频处理**

恰到好处的音乐能为游戏增色不少，所以拿到了设计师给的音频之后直接加到页面中再做做预加载，在电脑上的 Chrome 模拟手机端播放起来简直不能再完美。
嗯，模拟，意思就是放到真机上测试就不是那么回事了。

要说问题的话，主要是「 Android 多音频播放」+「 iOS 自动播放」两个大坑。

先说**「 Android 多音频播放」**，下面是在组里的测试机里面测试之后的实际情况：

![真机测试][5]

问了组里的小伙伴，小伙伴们说之前测试过很多安卓机都只支持单音频播放，但现在真是测试一遍倒发现支持情况倒还可以。不过组里的测试机作为样本并不一定能代表真实的市场情况，于是自己又在友盟上看了一下安卓机的市场份额：

![安卓设备占有率][6]
![安卓版本趋势][7]

还是很难把握绝大多数情况，于是开始想方法做一些 hack ：

①先是听 Bobbi 的意见，尝试了 iframe 的方法，在不同的页面中调用不同音频然后播放，再通过 iframe 将他们串联到同一个 html 文件中，尝试失败。

②又问了 Jolam 之前的处理方式，Jolam 说能支持 Web Audio API 的设备就一定能支持多音频，所以我又测试了一遍在不同设备的微信端对 Web Audio API 的支持情况，结果几乎全部都不支持，所以想尝试通过 AudioContext 来解决多音频问题也走不通了。

上周末前端早读课推送了一篇文章《[移动端HTML5音频与视频问题及解决方案][8]》，里面对安卓端多音频播放不给力的描述是这样说的：

> 低版本安卓上的问题没解，一般是混合开发都是可以调底层接口处理的，比如 phonegap 。

又怒搜了一圈，依然没有找到解决方法。

另一方面，在支持多音频播放的安卓机中表现出来的播放支持情况也并不完美，如果同时执行多个不同音频的 play 和 pause 方法，偶尔会导致其中一些无法生效，造成音频无法播放和无法停止的问题。

因此安卓端的多音频播放问题仍然没有很好地解决，只能做降级处理，在音效和背景音乐之间取舍，或者根据实际情况将它们合并。

再说**「 iOS 自动播放」**的问题。
简单描述就是，iOS 为了防止盗流量和提升体验对自动播放做了限制，只有用户跟界面有交互行为之后才能触发播放。
幸运的是，高版本微信对自动播放做了支持处理，具体实现方式问过微信的同学，应该不是通过 JS 完成的。

所以要么引导用户进行交互行为，暴露一个按钮、或者利用用户在无聊的时候喜欢乱点屏幕的心理去实现播放，要么想方法绕过限制去实现播放。
那么，如何绕过限制对低版本微信做自动播放处理？

尝试过的方法有：

①通过 createEvent 做事件模拟；
②通过 new 一张图片并监听其 onload 事件，结束后回调执行音频播放；
③在前两步的基础上，在回调当中动态创建 audio 对象，通过手动触发创建一个audio对象然后保存在全局中供需要使用。

或许是姿势不对，利用上述两种方法并没有达到想要的效果。
在版本 5.4 的微信中各种测试都无法实现自动播放，直到使用了微信的 JSSDK 。

因为这个游戏只能在微信端打开，所以可以直接利用微信 JSSDK 的网络状态获取接口实现首屏部分的自动播放功能。
    
    wx.getNetworkType({
        complete: function (res) {
            // 可以获取网络类型 res.networkType
            // 可以在这里执行音频播放
        }
    });

另外，上述的 `requestAnimationFrame()` 函数放在交互行为「点击」触发后执行的 ，而把音频写在这个函数里面执行播放和暂停操作时，依然不能在 iOS 端低版本微信中听到声音。

将音频分散写在不同的地方，既不便于管理，又增多了 HTTP 请求的数量，而且还有上述的不能播放问题。

既然如此，直接做雪碧音合并音频才是最好的解决方法。
需要合并的是那些在两次交互行为之间合成那些固定的音效文件，让他们实现顺序播放。
这样子既有利于音频管理，又解决了安卓端可能存在的无法播放多音频的方案选择问题：通过延迟播放音效，让支持多音频的安卓设备实现多音频播放，而不支持多音频的安卓设备在播放音效时阻断音乐达到降级的效果。

游戏的音频文件很多很碎，为了实现精确控制，最后使用 Adobe Audition 实现音频合并。
作为跟音频打交道最直接的人，我们精确地知道不同音频之间需要的间隔，所以由自己来完成音频合并其实才最精准。

游戏整体除了按钮部分，需要的音乐结构如下：

![音频播放][9]

Audition 的使用不难，在这里能直观的看到游戏主音效的波形情况：

![Audition][10]

实现合并操作需要的功能只有「生成 - 静音区」和「混合粘贴」，而后导出即可。

后期更改维护不方便？记录不同音频的插入时刻，将它们妥善保存备份，需要更改时其实也就是简单的复制粘贴操作而已。

综上所述，尽可能地合并音频，既增强了音频管理的科学性，也有利于利用 UA 检测去对安卓端和 iOS 端做针对性处理。

---

**第四部分，细节优化**

 1. **图片处理**
    为了兼容 retina 屏，我们会制作 2x （二倍）图，然后用 1x 的大小去引用图片。需要注意的是 2x 图的宽高必须是偶数大小，否则生成的 1x 图宽高不是整数会造成图片错位。

    当整体功能完成到需要做「性能优化」环节时，我们需要对图片进行雪碧图合并处理。
    
    从解放生产力的角度来讲我们应该善用工具，但从技能掌握角度来说我们还是应该掌握基本的 PS 拼图能力。工具方面，可以尝试 [Css Sprites][11] 或者 [GoPng][12]；PS 技能方面，我们可以把不同的图片放到一起，将它们放置在不同的图层分组方便二次修改。
    
    雪碧图合并需要注意的另一个问题是其中的小图片的间隔，每两个图片之间需要间隔至少 `4px`，然后适当增大图片本身的宽高，否则 rem → px 的换算中，由于 QQ 浏览器的内核数字类型为 int 不支持小数点，数字进行四舍五入，导致换算出来的 px 偏小时会使图片有被切割感。
    
    完成图片合并之后，我们可以利用 [TinyPng][13] 或者 [智图][14] 对图片进行压缩处理。个人体验是 TingPng 的压缩比要更高一些。
    
 2. **自适应方案**
    完美视图方案，具体思路可以是：
    ①先计算出实际设备的宽高比和设计稿的宽高比；
    ②利用设计稿宽高比和设备的宽高，算出设计稿在设备上等比缩放出来的实际宽高；
    ③若设备宽高比大于设计稿宽高比，则将文字缩放比设置为实际宽度 / 设计稿宽度；反之将文字宽度设置为实际高度 / 设计稿高度。

    用代码解释是：
    
    ```javascript
	var fixPages = (function (baseH, baseW, baseSize) {
		
		var screenW = document.body.clientWidth;
		var screenH = document.body.clientHeight;

		var baseRatio = Math.floor(baseW / baseH * 10000) / 10000;
		var screenRatio = Math.floor(screenW / screenH * 10000) / 10000;

		var realW = Math.floor(screenH * baseRatio);
		var realH = Math.floor(screenW / baseRatio);
		
		var scale = screenRatio >= baseRatio ? realW / baseW : realH / baseH;
		
		// 实际字体大小
		var newSize = Math.floor(parseInt(scale * 10000 * baseSize) / 10000);

	})(603, 375, 100);
    ```

    这里可能出现的问题有两个：
    ① 上面雪碧图说的图片切割感问题，若使用 rem 加雪碧图方案，需要增加元素的高度确保换算后若高度被截小图片仍能正常显示。
    ② 当时不小心设置了 body 的 font-size，导致在 iOS 上某些按钮宽度被定死无法修改。

 3. **动画实现方案**
    动画具体通过 `requestAnimationFrame()` 实现，简单来说就是在函数里面设定初始时间和当前时间，通过判断时间的变化进行不同的操作，并不断地重新进入函数。
    
    ```javascript
    var beginCountDown = function () {

		var countTime = new Date().getTime();	// 开始时间

		var step = function () {

			var countNewTime = new Date().getTime();    // 当刻时间

			if (countAllTime === countDownTime) {
				// 跳转第一时间将游戏屏恢复初始状态
			}

			if (countAllTime > 0 && countNewTime - countTime >= countDownTime * 1000){	
			    // 一开始进入的准备阶段，Ready Go!
			}

			if (countAllTime === 0){
                // 开始游戏
			}

			if (gameTime > 0 && countNewTime - countTime >= countNum * 10) {
				// 游戏进行中
			}

			if (gameTime === 0){
				// 游戏结束
			}

			if (resultTime > 0 && countNewTime - countTime >= resultTime * 1000) {
				// 跳转到摇到的钞票总数页并显示总钞票数
			} else {
				requestAnimationFrame(step);
			}
		}
		var req = requestAnimationFrame(step);
	}
    ```

    另一方面，通过 HTML5 的 devicemotion 监听手机的加速度变化，设定临界值使用户摇晃手机时增加唤醒钞票数。
    
    最终实现的具体效果如下（因为没有摇晃所有并没有唤醒钞票）：
    
    ![游戏过程][15]
    
---

**第五部分，体验提升**

好的作品应当注重细节，这次游戏里面也做了些提升体验的处理：

 1. **横屏提示**
    当页面并不能兼容横屏时需要添加横屏提示，提升体验。
    一般来说横屏提示有两种实现方案，其一是媒体查询，其二是监听横屏状态，分别为：

    ```
    // 1. 媒体查询
    @media screen and (orientation:landscape) {
        // CSS 样式写在这里
    }
    ```

    ```javascript
    // 2. 横屏监听
    var updateOrientation = function() {

    var $landscapeWrap = $('.landscape_wrap');

    if (window.orientation === -90 || window.orientation === 90) {
        $landscapeWrap.show();
        } else {
        $landscapeWrap.hide();
        }
    };
    window.onorientationchange = updateOrientation;
    ```

    媒体查询不适用的场景是，页面上有需要输入的文本内容的时候。
    当选中文本框进行输入的时候，虚拟键盘弹出导致屏幕变成横屏，从而触发媒体查询，因此在这种场景下不适合使用媒体查询方式。

 2. **预加载和 loading**
    为了保证游戏的连贯性，游戏需要对图片和音频资源进行预加载：
    图片部分，图片预加载可以通过 new Image() 后指定该 Image 对象的 src 实现，并通过该对象的 onload 事件确定图片加载完毕后进行下一步操作。
    音频部分，音频预加载与上类似，最后通过监听它的 canplaythrough 事件确定该资源加载完全。
    这里其实可以有更多考量，如利用微信 JSSDK 的网络状态获取接口，得到用户的网络类型之后加载不同的资源量以实现渐进增强。
    界面上，在预加载时添加一个可感知的 loading 页作为支持，也就是上面的企鹅拍金币动画。

---

**实习感言**

真的很感谢 enya、 tommy 和阿义让我通过面试给了我到 CDC 实习的机会，让我认识了狂拽酷炫的大家。
离职那天晚上跟彪叔喝酒聊天到凌晨五点，学到了巨多！（早点跟彪叔喝酒聊天的话说不定就不会走这么多弯路了= =）
也真的真的很感谢真哥这两个月教我做人做事，太多的 “谆谆教导” 我还并没有完全吸收，加油努力。

设计研发中心的大家真的教会了我很多，到这里实习过后阈值被调得那么高真是好麻烦啊。
在这里遇见的很厉害的大家，让自己的视野和眼界开阔了很多，也知道了自己的不足。

前端圈子说大不大说小不小，只要不断弥补自己的不足，无论在哪，总有一天会再会。

一点点地变靠谱起来吧。
再次，谢谢大家。

  [1]: http://7xidng.com1.z0.glb.clouddn.com/%E9%87%8D%E6%9E%84%E6%B5%81%E7%A8%8B.jpg
  [2]: http://7xidng.com1.z0.glb.clouddn.com/loading.gif
  [3]: http://7xidng.com1.z0.glb.clouddn.com/%E6%B4%92%E9%92%B1.gif
  [4]: http://7xidng.com1.z0.glb.clouddn.com/%E8%93%84%E5%8A%9B.gif
  [5]: http://7xidng.com1.z0.glb.clouddn.com/%E7%9C%9F%E6%9C%BA%E6%B5%8B%E8%AF%95.png
  [6]: http://7xidng.com1.z0.glb.clouddn.com/%E5%AE%89%E5%8D%93%E8%AE%BE%E5%A4%87%E5%8D%A0%E6%9C%89%E7%8E%87.png
  [7]: http://7xidng.com1.z0.glb.clouddn.com/%E5%AE%89%E5%8D%93%E7%89%88%E6%9C%AC%E8%B6%8B%E5%8A%BF.png
  [8]: http://www.cnblogs.com/aaronjs/p/4812119.html%AC%E8%B6%8B%E5%8A%BF.png
  [9]: http://7xidng.com1.z0.glb.clouddn.com/%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE.png
  [10]: http://7xidng.com1.z0.glb.clouddn.com/Audition.jpg
  [11]: http://csssprites.com/
  [12]: http://alloyteam.github.io/gopng/
  [13]: https://tinypng.com/
  [14]: http://zhitu.isux.us/
  [15]: http://7xidng.com1.z0.glb.clouddn.com/%E6%B8%B8%E6%88%8F%E8%BF%87%E7%A8%8B.gif
